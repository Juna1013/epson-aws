<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>å°„å‡ºæˆå‹ç²¾åº¦åˆ†æ - AWS ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³æˆæœç™ºè¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../assets/css/main.css" rel="stylesheet">
  </head>
  <body class="bg-gray-50 text-gray-900 antialiased">
    <!-- Header -->
    <header class="bg-white zenn-border border-b">
      <div class="max-w-6xl mx-auto px-4 py-3 md:py-4">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div class="flex items-center space-x-3 md:space-x-4 min-w-0">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center flex-shrink-0">
              <i class="fas fa-industry text-white text-sm md:text-lg"></i>
            </div>
            <div class="min-w-0">
              <h1 class="text-lg md:text-xl font-semibold text-gray-900 truncate">å°„å‡ºæˆå‹ç²¾åº¦åˆ†æ</h1>
              <p class="text-xs md:text-sm text-gray-500 truncate">AWS ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³æˆæœç™ºè¡¨ - ç•°å¸¸æ¤œçŸ¥ãƒ‡ãƒ¢</p>
            </div>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4 flex-shrink-0">
            <div class="hidden sm:flex items-center space-x-2">
              <i class="fas fa-sun text-orange-500 text-sm"></i>
              <div class="theme-toggle" onclick="toggleTheme()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ"></div>
              <i class="fas fa-moon text-blue-400 text-sm"></i>
            </div>
            <span class="bg-cyan-100 text-cyan-700 px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-medium">Demo</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 md:py-8">
      <!-- Hero Section -->
      <div class="text-center mb-8 md:mb-12">
        <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
          å°„å‡ºæˆå‹ç²¾åº¦åˆ†æ<br class="hidden sm:block">
          <span class="epson-accent">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã¿ãƒ‡ãƒ¢</span>
        </h1>
        <p class="text-base md:text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed px-4">
          æˆå‹æ¡ä»¶ï¼ˆæ¸©åº¦ãƒ»åœ§åŠ›ãƒ»æˆå½¢æ™‚é–“ï¼‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€API Gatewayâ†’Lambda(ç•°å¸¸æ¤œçŸ¥)â†’S3(ä¿å­˜) ã®æµã‚Œã‚’æ“¬ä¼¼åŒ–ã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã¯ä¸€åˆ‡ä¸è¦ã€‚
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼ -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
            <div class="p-6">
              <h3 class="text-xl font-semibold text-gray-900 mb-6">ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼</h3>
              <div class="flex items-center justify-between space-x-2 overflow-x-auto">
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                  <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-desktop text-blue-600 text-lg"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">Client</div>
                    <div class="text-sm text-gray-500">ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡</div>
                  </div>
                </div>
                <div class="flex items-center text-gray-400 px-2">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                  <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-route text-green-600 text-lg"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">API Gateway</div>
                    <div class="text-sm text-gray-500">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</div>
                  </div>
                </div>
                <div class="flex items-center text-gray-400 px-2">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                  <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-bolt text-orange-600 text-lg"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">Lambda</div>
                    <div class="text-sm text-gray-500">ç•°å¸¸æ¤œçŸ¥ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ</div>
                  </div>
                </div>
                <div class="flex items-center text-gray-400 px-2">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                  <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-database text-purple-600 text-lg"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">S3</div>
                    <div class="text-sm text-gray-500">é•·æœŸä¿å­˜</div>
                  </div>
                </div>
              </div>
              <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-700">
                  <i class="fas fa-info-circle mr-2"></i>
                  ã“ã®ãƒ‡ãƒ¢ã§ã¯ Lambda ã¨ S3 ã®æŒ™å‹•ã‚’ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§æ¨¡å€£ã—ã¦ã„ã¾ã™ã€‚
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
              ã‚¢ãƒ©ãƒ¼ãƒˆ
            </h3>
            <div id="alerts" class="space-y-2 max-h-64 overflow-y-auto"></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- æˆå‹æ©Ÿã‚»ãƒ³ã‚µãƒ¼è¨­å®š -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">
              <i class="fas fa-sliders-h text-gray-600 mr-2"></i>
              æˆå‹æ©Ÿã‚»ãƒ³ã‚µãƒ¼è¨­å®š
            </h3>
            <div class="space-y-6" id="settings">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ç›®æ¨™æ¸©åº¦ (Â°C): <span id="setTempVal" class="font-semibold text-orange-600">220</span>
                </label>
                <input id="setTemp" type="range" min="150" max="260" value="220" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>150Â°C</span>
                  <span>260Â°C</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ç›®æ¨™åœ§åŠ› (MPa): <span id="setPressVal" class="font-semibold text-green-600">80</span>
                </label>
                <input id="setPress" type="range" min="40" max="120" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>40 MPa</span>
                  <span>120 MPa</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ç›®æ¨™æˆå½¢æ™‚é–“ (ms): <span id="setTimeVal" class="font-semibold text-blue-600">300</span>
                </label>
                <input id="setTime" type="range" min="150" max="800" value="300" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>150 ms</span>
                  <span>800 ms</span>
                </div>
              </div>

              <div class="flex flex-wrap gap-3 pt-4">
                <button class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center" id="sendOnce">
                  <i class="fas fa-paper-plane mr-2"></i>ãƒ‡ãƒ¼ã‚¿ã‚’1å›é€ä¿¡
                </button>
                <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center" id="startStream">
                  <i class="fas fa-play mr-2"></i>é€£ç¶šé€ä¿¡: åœæ­¢
                </button>
                <button class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center" id="clearStorage">
                  <i class="fas fa-trash mr-2"></i>S3ã‚¯ãƒªã‚¢
                </button>
              </div>

              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600">
                  <i class="fas fa-info-circle mr-2"></i>
                  é€ä¿¡ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¸Šã§API Gatewayã‚’çµŒç”±ã—ã¦Lambda(ç•°å¸¸æ¤œçŸ¥)ã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã€æ­£å¸¸ãªã‚‰S3ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚é–¾å€¤è¶…éã§ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã€‚
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ– -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">
              <i class="fas fa-chart-line text-gray-600 mr-2"></i>
              ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–
            </h3>
            <div id="chart" class="bg-gray-50 rounded-lg p-4" style="height:240px;"></div>
            <div class="flex flex-wrap gap-4 mt-4">
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-orange-400 rounded-full"></div>
                <span class="text-sm text-gray-600">æ¸©åº¦ (Â°C)</span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                <span class="text-sm text-gray-600">åœ§åŠ› (MPa)</span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                <span class="text-sm text-gray-600">æˆå½¢æ™‚é–“ (ms)</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- API Gateway ãƒ­ã‚° -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              <i class="fas fa-terminal text-gray-600 mr-2"></i>
              API Gateway ãƒ­ã‚°
            </h3>
            <div id="log" class="bg-gray-900 text-green-400 p-4 rounded-lg h-48 overflow-auto font-mono text-sm whitespace-pre-wrap"></div>
            <div class="flex gap-3 mt-4">
              <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center text-sm" id="exportJson">
                <i class="fas fa-download mr-2"></i>JSON ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
              </button>
              <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center text-sm" id="downloadJson">
                <i class="fas fa-file-download mr-2"></i>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              </button>
            </div>
          </div>
        </div>

        <!-- S3 ä¿å­˜ -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              <i class="fas fa-database text-gray-600 mr-2"></i>
              ä¿å­˜ (S3 æ¨¡æ“¬)
            </h3>
            <div class="mb-4">
              <span class="text-sm text-gray-600">ä¿å­˜ä»¶æ•°: </span>
              <span id="s3count" class="font-semibold text-purple-600">0</span>
            </div>
            <div id="s3view" class="bg-gray-50 p-4 rounded-lg h-48 overflow-auto font-mono text-sm whitespace-pre-wrap text-gray-700"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-16">
      <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
          <!-- Left Section -->
          <div class="flex items-center space-x-4">
            <div class="w-8 h-8 bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center">
              <i class="fas fa-industry text-white text-sm"></i>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900 text-sm">å°„å‡ºæˆå‹ç²¾åº¦åˆ†æ</h3>
              <p class="text-xs text-gray-500">AWS ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³æˆæœç™ºè¡¨ - ç•°å¸¸æ¤œçŸ¥ãƒ‡ãƒ¢</p>
            </div>
          </div>
          
          <!-- Right Section -->
          <div class="text-right">
            <p class="text-sm text-gray-600 mb-1">ğŸ­ å°„å‡ºæˆå‹ç•°å¸¸æ¤œçŸ¥ãƒ‡ãƒ¢</p>
            <p class="text-xs text-gray-500">Lambda & S3 é€£æºã«ã‚ˆã‚‹å“è³ªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
          </div>
        </div>
        
        <!-- Bottom Section -->
        <div class="mt-6 pt-4 border-t border-gray-100">
          <p class="text-sm text-gray-600 leading-relaxed">
            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
            <strong>ãƒ’ãƒ³ãƒˆ:</strong> æ¸©åº¦ãƒ»åœ§åŠ›ãƒ»æˆå½¢æ™‚é–“ã®ç›®æ¨™ã‚’å¤‰ãˆã¦ã€é€£ç¶šé€ä¿¡ã€ã‚’é–‹å§‹ã™ã‚‹ã¨ã€æ“¬ä¼¼çš„ãªãƒã‚¤ã‚ºã‚„ãƒ‰ãƒªãƒ•ãƒˆãŒå…¥ã‚Šã€Lambdaï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰ã«ã‚ˆã‚‹ç•°å¸¸æ¤œçŸ¥ãŒåƒãã¾ã™ã€‚ä¿å­˜ã¯ localStorage ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚æ®‹ã‚Šã¾ã™ã€‚
          </p>
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-100 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
          <p class="text-xs text-gray-400">Â© 2025 Seiko Epson Corporation. All rights reserved.</p>
          <div class="flex items-center space-x-4 text-xs text-gray-400">
            <span class="flex items-center">
              <i class="fas fa-code mr-1"></i>
              Built with AWS
            </span>
            <span class="flex items-center">
              <i class="fas fa-heart mr-1 text-red-400"></i>
              Made with care
            </span>
          </div>
        </div>
      </div>
    </footer>

<script>
// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & åˆæœŸè¨­å®š ---
const setTemp = document.getElementById('setTemp');
const setPress = document.getElementById('setPress');
const setTime = document.getElementById('setTime');
const setTempVal = document.getElementById('setTempVal');
const setPressVal = document.getElementById('setPressVal');
const setTimeVal = document.getElementById('setTimeVal');
const sendOnce = document.getElementById('sendOnce');
const startStream = document.getElementById('startStream');
const clearStorage = document.getElementById('clearStorage');
const logEl = document.getElementById('log');
const alertsEl = document.getElementById('alerts');
const s3view = document.getElementById('s3view');
const s3count = document.getElementById('s3count');
const exportJson = document.getElementById('exportJson');
const downloadJson = document.getElementById('downloadJson');

let streaming = false;
let streamTimer = null;

// localStorage key for simulated S3
const S3_KEY = 'sim_s3_injection_molding';

// update UI values
function updateSetUI(){ setTempVal.textContent = setTemp.value; setPressVal.textContent = setPress.value; setTimeVal.textContent = setTime.value; }
[setTemp,setPress,setTime].forEach(el=>el.addEventListener('input',updateSetUI));
updateSetUI();

// --- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ£ãƒ¼ãƒˆ(è»½é‡) ---
const chartEl = document.getElementById('chart');
let samples = []; // æœ€æ–°ãƒ‡ãƒ¼ã‚¿é…åˆ—

function drawChart(){
  chartEl.innerHTML = '';
  const w = chartEl.clientWidth || 700;
  const h = 240;
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
  svg.setAttribute('width', '100%');
  svg.setAttribute('height', h);

  // background grid
  for(let i=0;i<5;i++){
    const y = (h/4)*i;
    const line = document.createElementNS(svgNS,'line');
    line.setAttribute('x1',0); line.setAttribute('x2',w); line.setAttribute('y1',y); line.setAttribute('y2',y);
    line.setAttribute('stroke','rgba(255,255,255,0.03)'); line.setAttribute('stroke-width',1);
    svg.appendChild(line);
  }
  // draw series: temp, press, time
  if(samples.length>0){
    const pad = 20; const plotW = w-2*pad; const plotH = h-2*pad;
    const N = Math.max(1,samples.length-1);

    // helpers
    const getX = (i)=> pad + (i/N)*plotW;
    const tempVals = samples.map(s=>s.temp);
    const pressVals = samples.map(s=>s.press);
    const timeVals = samples.map(s=>s.mtime);
    const minAll = Math.min(...tempVals, ...pressVals, ...timeVals);
    const maxAll = Math.max(...tempVals, ...pressVals, ...timeVals);
    const range = Math.max(1, maxAll - minAll);
    const getY = (v)=> pad + plotH - ((v - minAll)/range)*plotH;

    function drawPath(vals,cls){
      const path = document.createElementNS(svgNS,'path');
      let d = '';
      vals.forEach((v,i)=>{ const x=getX(i); const y=getY(v); d += (i===0?`M ${x},${y}`:` L ${x},${y}`); });
      path.setAttribute('d',d); path.setAttribute('fill','none'); path.setAttribute('stroke-width',2);
      if(cls==='temp') path.setAttribute('stroke','#ffb86b');
      if(cls==='press') path.setAttribute('stroke','#7ee787');
      if(cls==='time') path.setAttribute('stroke','#93c5fd');
      svg.appendChild(path);
    }
    drawPath(tempVals,'temp'); drawPath(pressVals,'press'); drawPath(timeVals,'time');

    // draw latest dots
    const last = samples[samples.length-1];
    [['temp','#ffb86b',last.temp],['press','#7ee787',last.press],['time','#93c5fd',last.mtime]].forEach(([k,color,v],i)=>{
      const cx = getX(samples.length-1); const cy = getY(v);
      const c = document.createElementNS(svgNS,'circle');
      c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',4); c.setAttribute('fill',color);
      svg.appendChild(c);
    });
  }
  chartEl.appendChild(svg);
}

// --- ç–‘ä¼¼ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ ---
function generateSample(){
  // åŸºæœ¬ã¯ç›®æ¨™å€¤ã«ãƒã‚¤ã‚ºã¨ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æ··ãœã‚‹
  const goalTemp = Number(setTemp.value);
  const goalPress = Number(setPress.value);
  const goalTime = Number(setTime.value);

  // ãƒã‚¤ã‚ºã¨æ™‚ç³»åˆ—è¦ç´ 
  const t = Date.now();
  const drift = Math.sin(t/50000)*3; // ã‚†ã£ãã‚Šãƒ‰ãƒªãƒ•ãƒˆ
  const noiseTemp = (Math.random()-0.5)*6; // Â±3
  const noisePress = (Math.random()-0.5)*6;
  const noiseTime = (Math.random()-0.5)*40;

  const temp = Math.round((goalTemp + drift + noiseTemp)*10)/10;
  const press = Math.round((goalPress + drift*0.2 + noisePress)*10)/10;
  const mtime = Math.round((goalTime + noiseTime));

  return { ts: new Date().toISOString(), temp, press, mtime };
}

// --- API Gateway (æ¨¡æ“¬) ---
function apiGateway_receive(sample){
  log(`API Gateway: å—ä¿¡ ts=${sample.ts} temp=${sample.temp} press=${sample.press} time=${sample.mtime}`);
  // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: è§£æç”¨ã¨ä¿å­˜ç”¨ã«é€ã‚‹
  const analysisRes = lambda_analyze(sample);
  if(analysisRes.store) {
    s3_put(sample);
    log('API Gateway: S3ã¸ä¿å­˜å®Œäº†');
  } else {
    log('API Gateway: ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ— (é‡å¤§ã‚¢ãƒ©ãƒ¼ãƒˆã‚„ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶)');
  }
}

// --- Lambda (ç•°å¸¸æ¤œçŸ¥) ---
// ã‚·ãƒ³ãƒ—ãƒ«ãªé–¾å€¤ + å±€æ‰€å¹³å‡ã¨ã®zã‚¹ã‚³ã‚¢ã«ã‚ˆã‚‹æ¤œå‡º
function lambda_analyze(sample){
  // ãƒ­ãƒ¼ã‚«ãƒ«ã®ç›´è¿‘ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰å¹³å‡/åˆ†æ•£ã‚’å–ã‚‹
  const window = samples.slice(-20);
  const temps = window.map(s=>s.temp);
  const presses = window.map(s=>s.press);
  const times = window.map(s=>s.mtime);

  function mean(arr){ if(arr.length==0) return null; return arr.reduce((a,b)=>a+b,0)/arr.length }
  function stdev(arr){ const m=mean(arr); if(m===null) return null; return Math.sqrt(arr.reduce((s,x)=>s+(x-m)*(x-m),0)/arr.length) }

  const anomalies = [];
  // çµ¶å¯¾é–¾å€¤
  if(sample.temp < 160 || sample.temp > 250) anomalies.push({level:'crit',msg:`æ¸©åº¦ç•°å¸¸: ${sample.temp}Â°C`});
  if(sample.press < 50 || sample.press > 110) anomalies.push({level:'warn',msg:`åœ§åŠ›ç•°å¸¸: ${sample.press} MPa`});
  if(sample.mtime < 160 || sample.mtime > 700) anomalies.push({level:'warn',msg:`æˆå½¢æ™‚é–“ç•°å¸¸: ${sample.mtime} ms`});

  // zã‚¹ã‚³ã‚¢ã§ã®ç•°å¸¸ (å±€æ‰€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¨æ¯”è¼ƒ)
  const mT = mean(temps); const sT = stdev(temps);
  if(mT!==null && sT>0){ const z = Math.abs((sample.temp - mT)/sT); if(z>3) anomalies.push({level:'crit',msg:`æ¸©åº¦æ€¥å¤‰ (z=${z.toFixed(1)})`}); }

  const mP = mean(presses); const sP = stdev(presses);
  if(mP!==null && sP>0){ const z = Math.abs((sample.press - mP)/sP); if(z>3) anomalies.push({level:'crit',msg:`åœ§åŠ›æ€¥å¤‰ (z=${z.toFixed(1)})`}); }

  // ã‚¢ãƒ©ãƒ¼ãƒˆå‡ºåŠ›
  if(anomalies.length>0){
    anomalies.forEach(a=>pushAlert(a.level,a.msg,sample));
    return { store: true, anomalies };
  }
  // æ­£å¸¸
  return { store: true, anomalies: [] };
}

// --- S3 (localStorageã‚’åˆ©ç”¨) ---
function s3_put(sample){
  const arr = JSON.parse(localStorage.getItem(S3_KEY) || '[]');
  arr.push(sample);
  localStorage.setItem(S3_KEY, JSON.stringify(arr));
  renderS3();
}

function s3_list(){ return JSON.parse(localStorage.getItem(S3_KEY) || '[]'); }

function s3_clear(){ localStorage.removeItem(S3_KEY); renderS3(); }

function renderS3(){ const arr = s3_list(); s3count.textContent = arr.length; s3view.textContent = arr.slice(-20).map(j=>JSON.stringify(j)).reverse().join('\n'); }

// --- ãƒ­ã‚°/ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç† ---
function log(msg){ const now = new Date().toLocaleTimeString(); logEl.textContent = `[${now}] ${msg}\n` + logEl.textContent; }

function pushAlert(level,msg,sample){
  const el = document.createElement('div');
  let alertClass, iconClass;
  if(level === 'crit') {
    alertClass = 'bg-red-100 text-red-800 border border-red-200';
    iconClass = 'fas fa-exclamation-circle text-red-600';
  } else {
    alertClass = 'bg-yellow-100 text-yellow-800 border border-yellow-200';
    iconClass = 'fas fa-exclamation-triangle text-yellow-600';
  }
  el.className = `${alertClass} p-3 rounded-lg flex items-start space-x-2 text-sm`;
  el.innerHTML = `<i class="${iconClass} mt-0.5"></i><div><div class="font-medium">${new Date().toLocaleTimeString()}</div><div>${msg}</div></div>`;
  alertsEl.prepend(el);
  // é‡è¦ãªå ´åˆã¯S3ã¸ã‚‚ç›´æ¥è¨˜éŒ² (ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜)
  const events = JSON.parse(localStorage.getItem(S3_KEY + '_events') || '[]');
  events.push({ts: new Date().toISOString(), level, msg, sample});
  localStorage.setItem(S3_KEY + '_events', JSON.stringify(events));
}

// --- UI ãƒãƒ³ãƒ‰ãƒ© ---
sendOnce.addEventListener('click',()=>{ const s = generateSample(); samples.push(s); if(samples.length>200) samples.shift(); drawChart(); apiGateway_receive(s); renderS3(); });

startStream.addEventListener('click',()=>{
  streaming = !streaming; startStream.textContent = streaming? 'é€£ç¶šé€ä¿¡: é–‹å§‹ä¸­' : 'é€£ç¶šé€ä¿¡: åœæ­¢';
  if(streaming){ streamTimer = setInterval(()=>{ const s = generateSample(); samples.push(s); if(samples.length>200) samples.shift(); drawChart(); apiGateway_receive(s); }, 900); }
  else { clearInterval(streamTimer); }
});

clearStorage.addEventListener('click',()=>{ if(confirm('S3æ¨¡æ“¬ä¿å­˜ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){ s3_clear(); localStorage.removeItem(S3_KEY + '_events'); log('S3ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'); }});

exportJson.addEventListener('click',()=>{ const data = { saved: s3_list(), events: JSON.parse(localStorage.getItem(S3_KEY + '_events')||'[]') }; const str = JSON.stringify(data, null, 2); alert('S3ã®å†…å®¹ã‚’JSONæ–‡å­—åˆ—ã¨ã—ã¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã™ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚'); console.log(str); });

downloadJson.addEventListener('click',()=>{ const data = { saved: s3_list(), events: JSON.parse(localStorage.getItem(S3_KEY + '_events')||'[]') }; const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sim_s3_injection_molding.json'; a.click(); URL.revokeObjectURL(url); });

// åˆå›æç”»ãƒ»ãƒ­ãƒ¼ãƒ‰
(function init(){
  // ç›´è¿‘ã«ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œã£ã¦è¡¨ç¤º
  for(let i=0;i<30;i++){ const s = generateSample(); s.ts = new Date(Date.now() - (30-i)*60000).toISOString(); samples.push(s); }
  drawChart(); renderS3(); log('ãƒ‡ãƒ¢ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
})();

</script>

    <script src="../assets/js/theme.js"></script>
  </body>
</html>
