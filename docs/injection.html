<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>射出成型精度分析 - AWS インターン成果発表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../assets/css/main.css" rel="stylesheet">
  </head>
  <body class="bg-gray-50 text-gray-900 antialiased">
    <!-- Header -->
    <header class="bg-white zenn-border border-b">
      <div class="max-w-6xl mx-auto px-4 py-3 md:py-4">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div class="flex items-center space-x-3 md:space-x-4 min-w-0">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center flex-shrink-0">
              <i class="fas fa-industry text-white text-sm md:text-lg"></i>
            </div>
            <div class="min-w-0">
              <h1 class="text-lg md:text-xl font-semibold text-gray-900 truncate">射出成型精度分析</h1>
              <p class="text-xs md:text-sm text-gray-500 truncate">AWS インターン成果発表 - 異常検知デモ</p>
            </div>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4 flex-shrink-0">
            <div class="hidden sm:flex items-center space-x-2">
              <i class="fas fa-sun text-orange-500 text-sm"></i>
              <div class="theme-toggle" onclick="toggleTheme()" title="ダークモード切り替え"></div>
              <i class="fas fa-moon text-blue-400 text-sm"></i>
            </div>
            <span class="bg-cyan-100 text-cyan-700 px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-medium">Demo</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 md:py-8">
      <!-- Hero Section -->
      <div class="text-center mb-8 md:mb-12">
        <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
          射出成型精度分析<br class="hidden sm:block">
          <span class="epson-accent">クライアントのみデモ</span>
        </h1>
        <p class="text-base md:text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed px-4">
          成型条件（温度・圧力・成形時間）をクライアント側でシミュレートし、API Gateway→Lambda(異常検知)→S3(保存) の流れを擬似化します。サーバーは一切不要。
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- システムフロー -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
            <div class="p-6">
              <h3 class="text-xl font-semibold text-gray-900 mb-6">システムフロー</h3>
              <div class="flex items-center justify-between space-x-2 overflow-x-auto">
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                  <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-desktop text-blue-600 text-lg"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">Client</div>
                    <div class="text-sm text-gray-500">センサーデータ送信</div>
                  </div>
                </div>
                <div class="flex items-center text-gray-400 px-2">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                  <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-route text-green-600 text-lg"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">API Gateway</div>
                    <div class="text-sm text-gray-500">ルーティング</div>
                  </div>
                </div>
                <div class="flex items-center text-gray-400 px-2">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                  <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-bolt text-orange-600 text-lg"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">Lambda</div>
                    <div class="text-sm text-gray-500">異常検知・アラート</div>
                  </div>
                </div>
                <div class="flex items-center text-gray-400 px-2">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                  <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-database text-purple-600 text-lg"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">S3</div>
                    <div class="text-sm text-gray-500">長期保存</div>
                  </div>
                </div>
              </div>
              <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-700">
                  <i class="fas fa-info-circle mr-2"></i>
                  このデモでは Lambda と S3 の挙動をブラウザ内で模倣しています。
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- アラート -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
              アラート
            </h3>
            <div id="alerts" class="space-y-2 max-h-64 overflow-y-auto"></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- 成型機センサー設定 -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">
              <i class="fas fa-sliders-h text-gray-600 mr-2"></i>
              成型機センサー設定
            </h3>
            <div class="space-y-6" id="settings">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  目標温度 (°C): <span id="setTempVal" class="font-semibold text-orange-600">220</span>
                </label>
                <input id="setTemp" type="range" min="150" max="260" value="220" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>150°C</span>
                  <span>260°C</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  目標圧力 (MPa): <span id="setPressVal" class="font-semibold text-green-600">80</span>
                </label>
                <input id="setPress" type="range" min="40" max="120" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>40 MPa</span>
                  <span>120 MPa</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  目標成形時間 (ms): <span id="setTimeVal" class="font-semibold text-blue-600">300</span>
                </label>
                <input id="setTime" type="range" min="150" max="800" value="300" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>150 ms</span>
                  <span>800 ms</span>
                </div>
              </div>

              <div class="flex flex-wrap gap-3 pt-4">
                <button class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center" id="sendOnce">
                  <i class="fas fa-paper-plane mr-2"></i>データを1回送信
                </button>
                <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center" id="startStream">
                  <i class="fas fa-play mr-2"></i>連続送信: 停止
                </button>
                <button class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center" id="clearStorage">
                  <i class="fas fa-trash mr-2"></i>S3クリア
                </button>
              </div>

              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600">
                  <i class="fas fa-info-circle mr-2"></i>
                  送信はクライアント上でAPI Gatewayを経由してLambda(異常検知)へルーティングされ、正常ならS3に保存されます。閾値超過でアラート表示。
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- データ可視化 -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">
              <i class="fas fa-chart-line text-gray-600 mr-2"></i>
              データ可視化
            </h3>
            <div id="chart" class="bg-gray-50 rounded-lg p-4" style="height:240px;"></div>
            <div class="flex flex-wrap gap-4 mt-4">
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-orange-400 rounded-full"></div>
                <span class="text-sm text-gray-600">温度 (°C)</span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                <span class="text-sm text-gray-600">圧力 (MPa)</span>
              </div>
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                <span class="text-sm text-gray-600">成形時間 (ms)</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- API Gateway ログ -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              <i class="fas fa-terminal text-gray-600 mr-2"></i>
              API Gateway ログ
            </h3>
            <div id="log" class="bg-gray-900 text-green-400 p-4 rounded-lg h-48 overflow-auto font-mono text-sm whitespace-pre-wrap"></div>
            <div class="flex gap-3 mt-4">
              <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center text-sm" id="exportJson">
                <i class="fas fa-download mr-2"></i>JSON エクスポート
              </button>
              <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center text-sm" id="downloadJson">
                <i class="fas fa-file-download mr-2"></i>ダウンロード
              </button>
            </div>
          </div>
        </div>

        <!-- S3 保存 -->
        <div class="bg-white rounded-xl zenn-shadow zenn-border overflow-hidden">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              <i class="fas fa-database text-gray-600 mr-2"></i>
              保存 (S3 模擬)
            </h3>
            <div class="mb-4">
              <span class="text-sm text-gray-600">保存件数: </span>
              <span id="s3count" class="font-semibold text-purple-600">0</span>
            </div>
            <div id="s3view" class="bg-gray-50 p-4 rounded-lg h-48 overflow-auto font-mono text-sm whitespace-pre-wrap text-gray-700"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-16">
      <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
          <!-- Left Section -->
          <div class="flex items-center space-x-4">
            <div class="w-8 h-8 bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center">
              <i class="fas fa-industry text-white text-sm"></i>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900 text-sm">射出成型精度分析</h3>
              <p class="text-xs text-gray-500">AWS インターン成果発表 - 異常検知デモ</p>
            </div>
          </div>
          
          <!-- Right Section -->
          <div class="text-right">
            <p class="text-sm text-gray-600 mb-1">🏭 射出成型異常検知デモ</p>
            <p class="text-xs text-gray-500">Lambda & S3 連携による品質管理システム</p>
          </div>
        </div>
        
        <!-- Bottom Section -->
        <div class="mt-6 pt-4 border-t border-gray-100">
          <p class="text-sm text-gray-600 leading-relaxed">
            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
            <strong>ヒント:</strong> 温度・圧力・成形時間の目標を変えて『連続送信』を開始すると、擬似的なノイズやドリフトが入り、Lambda（ブラウザ内）による異常検知が働きます。保存は localStorage を使っているためブラウザを閉じても残ります。
          </p>
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-100 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
          <p class="text-xs text-gray-400">© 2025 Seiko Epson Corporation. All rights reserved.</p>
          <div class="flex items-center space-x-4 text-xs text-gray-400">
            <span class="flex items-center">
              <i class="fas fa-code mr-1"></i>
              Built with AWS
            </span>
            <span class="flex items-center">
              <i class="fas fa-heart mr-1 text-red-400"></i>
              Made with care
            </span>
          </div>
        </div>
      </div>
    </footer>

<script>
// --- ユーティリティ & 初期設定 ---
const setTemp = document.getElementById('setTemp');
const setPress = document.getElementById('setPress');
const setTime = document.getElementById('setTime');
const setTempVal = document.getElementById('setTempVal');
const setPressVal = document.getElementById('setPressVal');
const setTimeVal = document.getElementById('setTimeVal');
const sendOnce = document.getElementById('sendOnce');
const startStream = document.getElementById('startStream');
const clearStorage = document.getElementById('clearStorage');
const logEl = document.getElementById('log');
const alertsEl = document.getElementById('alerts');
const s3view = document.getElementById('s3view');
const s3count = document.getElementById('s3count');
const exportJson = document.getElementById('exportJson');
const downloadJson = document.getElementById('downloadJson');

let streaming = false;
let streamTimer = null;

// localStorage key for simulated S3
const S3_KEY = 'sim_s3_injection_molding';

// update UI values
function updateSetUI(){ setTempVal.textContent = setTemp.value; setPressVal.textContent = setPress.value; setTimeVal.textContent = setTime.value; }
[setTemp,setPress,setTime].forEach(el=>el.addEventListener('input',updateSetUI));
updateSetUI();

// --- シンプルなチャート(軽量) ---
const chartEl = document.getElementById('chart');
let samples = []; // 最新データ配列

function drawChart(){
  chartEl.innerHTML = '';
  const w = chartEl.clientWidth || 700;
  const h = 240;
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
  svg.setAttribute('width', '100%');
  svg.setAttribute('height', h);

  // background grid
  for(let i=0;i<5;i++){
    const y = (h/4)*i;
    const line = document.createElementNS(svgNS,'line');
    line.setAttribute('x1',0); line.setAttribute('x2',w); line.setAttribute('y1',y); line.setAttribute('y2',y);
    line.setAttribute('stroke','rgba(255,255,255,0.03)'); line.setAttribute('stroke-width',1);
    svg.appendChild(line);
  }
  // draw series: temp, press, time
  if(samples.length>0){
    const pad = 20; const plotW = w-2*pad; const plotH = h-2*pad;
    const N = Math.max(1,samples.length-1);

    // helpers
    const getX = (i)=> pad + (i/N)*plotW;
    const tempVals = samples.map(s=>s.temp);
    const pressVals = samples.map(s=>s.press);
    const timeVals = samples.map(s=>s.mtime);
    const minAll = Math.min(...tempVals, ...pressVals, ...timeVals);
    const maxAll = Math.max(...tempVals, ...pressVals, ...timeVals);
    const range = Math.max(1, maxAll - minAll);
    const getY = (v)=> pad + plotH - ((v - minAll)/range)*plotH;

    function drawPath(vals,cls){
      const path = document.createElementNS(svgNS,'path');
      let d = '';
      vals.forEach((v,i)=>{ const x=getX(i); const y=getY(v); d += (i===0?`M ${x},${y}`:` L ${x},${y}`); });
      path.setAttribute('d',d); path.setAttribute('fill','none'); path.setAttribute('stroke-width',2);
      if(cls==='temp') path.setAttribute('stroke','#ffb86b');
      if(cls==='press') path.setAttribute('stroke','#7ee787');
      if(cls==='time') path.setAttribute('stroke','#93c5fd');
      svg.appendChild(path);
    }
    drawPath(tempVals,'temp'); drawPath(pressVals,'press'); drawPath(timeVals,'time');

    // draw latest dots
    const last = samples[samples.length-1];
    [['temp','#ffb86b',last.temp],['press','#7ee787',last.press],['time','#93c5fd',last.mtime]].forEach(([k,color,v],i)=>{
      const cx = getX(samples.length-1); const cy = getY(v);
      const c = document.createElementNS(svgNS,'circle');
      c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',4); c.setAttribute('fill',color);
      svg.appendChild(c);
    });
  }
  chartEl.appendChild(svg);
}

// --- 疑似センサーデータ生成 ---
function generateSample(){
  // 基本は目標値にノイズとトレンドを混ぜる
  const goalTemp = Number(setTemp.value);
  const goalPress = Number(setPress.value);
  const goalTime = Number(setTime.value);

  // ノイズと時系列要素
  const t = Date.now();
  const drift = Math.sin(t/50000)*3; // ゆっくりドリフト
  const noiseTemp = (Math.random()-0.5)*6; // ±3
  const noisePress = (Math.random()-0.5)*6;
  const noiseTime = (Math.random()-0.5)*40;

  const temp = Math.round((goalTemp + drift + noiseTemp)*10)/10;
  const press = Math.round((goalPress + drift*0.2 + noisePress)*10)/10;
  const mtime = Math.round((goalTime + noiseTime));

  return { ts: new Date().toISOString(), temp, press, mtime };
}

// --- API Gateway (模擬) ---
function apiGateway_receive(sample){
  log(`API Gateway: 受信 ts=${sample.ts} temp=${sample.temp} press=${sample.press} time=${sample.mtime}`);
  // ルーティング: 解析用と保存用に送る
  const analysisRes = lambda_analyze(sample);
  if(analysisRes.store) {
    s3_put(sample);
    log('API Gateway: S3へ保存完了');
  } else {
    log('API Gateway: 保存をスキップ (重大アラートやフィルタ条件)');
  }
}

// --- Lambda (異常検知) ---
// シンプルな閾値 + 局所平均とのzスコアによる検出
function lambda_analyze(sample){
  // ローカルの直近ウィンドウから平均/分散を取る
  const window = samples.slice(-20);
  const temps = window.map(s=>s.temp);
  const presses = window.map(s=>s.press);
  const times = window.map(s=>s.mtime);

  function mean(arr){ if(arr.length==0) return null; return arr.reduce((a,b)=>a+b,0)/arr.length }
  function stdev(arr){ const m=mean(arr); if(m===null) return null; return Math.sqrt(arr.reduce((s,x)=>s+(x-m)*(x-m),0)/arr.length) }

  const anomalies = [];
  // 絶対閾値
  if(sample.temp < 160 || sample.temp > 250) anomalies.push({level:'crit',msg:`温度異常: ${sample.temp}°C`});
  if(sample.press < 50 || sample.press > 110) anomalies.push({level:'warn',msg:`圧力異常: ${sample.press} MPa`});
  if(sample.mtime < 160 || sample.mtime > 700) anomalies.push({level:'warn',msg:`成形時間異常: ${sample.mtime} ms`});

  // zスコアでの異常 (局所ウィンドウと比較)
  const mT = mean(temps); const sT = stdev(temps);
  if(mT!==null && sT>0){ const z = Math.abs((sample.temp - mT)/sT); if(z>3) anomalies.push({level:'crit',msg:`温度急変 (z=${z.toFixed(1)})`}); }

  const mP = mean(presses); const sP = stdev(presses);
  if(mP!==null && sP>0){ const z = Math.abs((sample.press - mP)/sP); if(z>3) anomalies.push({level:'crit',msg:`圧力急変 (z=${z.toFixed(1)})`}); }

  // アラート出力
  if(anomalies.length>0){
    anomalies.forEach(a=>pushAlert(a.level,a.msg,sample));
    return { store: true, anomalies };
  }
  // 正常
  return { store: true, anomalies: [] };
}

// --- S3 (localStorageを利用) ---
function s3_put(sample){
  const arr = JSON.parse(localStorage.getItem(S3_KEY) || '[]');
  arr.push(sample);
  localStorage.setItem(S3_KEY, JSON.stringify(arr));
  renderS3();
}

function s3_list(){ return JSON.parse(localStorage.getItem(S3_KEY) || '[]'); }

function s3_clear(){ localStorage.removeItem(S3_KEY); renderS3(); }

function renderS3(){ const arr = s3_list(); s3count.textContent = arr.length; s3view.textContent = arr.slice(-20).map(j=>JSON.stringify(j)).reverse().join('\n'); }

// --- ログ/アラート管理 ---
function log(msg){ const now = new Date().toLocaleTimeString(); logEl.textContent = `[${now}] ${msg}\n` + logEl.textContent; }

function pushAlert(level,msg,sample){
  const el = document.createElement('div');
  let alertClass, iconClass;
  if(level === 'crit') {
    alertClass = 'bg-red-100 text-red-800 border border-red-200';
    iconClass = 'fas fa-exclamation-circle text-red-600';
  } else {
    alertClass = 'bg-yellow-100 text-yellow-800 border border-yellow-200';
    iconClass = 'fas fa-exclamation-triangle text-yellow-600';
  }
  el.className = `${alertClass} p-3 rounded-lg flex items-start space-x-2 text-sm`;
  el.innerHTML = `<i class="${iconClass} mt-0.5"></i><div><div class="font-medium">${new Date().toLocaleTimeString()}</div><div>${msg}</div></div>`;
  alertsEl.prepend(el);
  // 重要な場合はS3へも直接記録 (イベント保存)
  const events = JSON.parse(localStorage.getItem(S3_KEY + '_events') || '[]');
  events.push({ts: new Date().toISOString(), level, msg, sample});
  localStorage.setItem(S3_KEY + '_events', JSON.stringify(events));
}

// --- UI ハンドラ ---
sendOnce.addEventListener('click',()=>{ const s = generateSample(); samples.push(s); if(samples.length>200) samples.shift(); drawChart(); apiGateway_receive(s); renderS3(); });

startStream.addEventListener('click',()=>{
  streaming = !streaming; startStream.textContent = streaming? '連続送信: 開始中' : '連続送信: 停止';
  if(streaming){ streamTimer = setInterval(()=>{ const s = generateSample(); samples.push(s); if(samples.length>200) samples.shift(); drawChart(); apiGateway_receive(s); }, 900); }
  else { clearInterval(streamTimer); }
});

clearStorage.addEventListener('click',()=>{ if(confirm('S3模擬保存をクリアします。よろしいですか？')){ s3_clear(); localStorage.removeItem(S3_KEY + '_events'); log('S3をクリアしました'); }});

exportJson.addEventListener('click',()=>{ const data = { saved: s3_list(), events: JSON.parse(localStorage.getItem(S3_KEY + '_events')||'[]') }; const str = JSON.stringify(data, null, 2); alert('S3の内容をJSON文字列としてコンソールに出力します。ダウンロードは下のボタンを使用してください。'); console.log(str); });

downloadJson.addEventListener('click',()=>{ const data = { saved: s3_list(), events: JSON.parse(localStorage.getItem(S3_KEY + '_events')||'[]') }; const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sim_s3_injection_molding.json'; a.click(); URL.revokeObjectURL(url); });

// 初回描画・ロード
(function init(){
  // 直近にランダムサンプルを作って表示
  for(let i=0;i<30;i++){ const s = generateSample(); s.ts = new Date(Date.now() - (30-i)*60000).toISOString(); samples.push(s); }
  drawChart(); renderS3(); log('デモを初期化しました');
})();

</script>

    <script src="../assets/js/theme.js"></script>
  </body>
</html>
